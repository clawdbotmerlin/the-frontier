<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandarmology Screener - IDX LQ45</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
        }
        .header {
            background: #1e293b;
            padding: 20px;
            border-bottom: 1px solid #334155;
        }
        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p { color: #94a3b8; font-size: 14px; margin-top: 4px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }
        .stat-card .label { color: #94a3b8; font-size: 12px; text-transform: uppercase; }
        .stat-card .value { font-size: 28px; font-weight: bold; margin-top: 8px; }
        .buy { color: #22c55e; }
        .hold { color: #eab308; }
        .sell { color: #ef4444; }
        .loading {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }
        .error {
            background: #7f1d1d;
            color: #fecaca;
            padding: 16px;
            border-radius: 8px;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
        }
        th {
            background: #334155;
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #94a3b8;
            cursor: pointer;
        }
        th:hover { background: #475569; }
        td {
            padding: 16px;
            border-bottom: 1px solid #334155;
        }
        tr:hover { background: #334155/50; }
        .stock-name { display: flex; align-items: center; gap: 12px; }
        .stock-name img { width: 32px; height: 32px; border-radius: 6px; }
        .stock-name .symbol { font-weight: 600; }
        .stock-name .full-name { font-size: 12px; color: #94a3b8; }
        .price { text-align: right; }
        .change { text-align: right; font-weight: 500; }
        .change.positive { color: #22c55e; }
        .change.negative { color: #ef4444; }
        .score { text-align: center; font-size: 20px; font-weight: bold; }
        .signal {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .signal-buy { background: #22c55e; color: #fff; }
        .signal-hold { background: #eab308; color: #000; }
        .signal-sell { background: #ef4444; color: #fff; }
        .refresh-btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover { background: #2563eb; }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .detail-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1e293b;
            border-left: 1px solid #334155;
            padding: 24px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
        }
        .detail-panel.active { transform: translateX(0); }
        .detail-panel h2 { margin-bottom: 20px; }
        .detail-panel .close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }
        .reasoning {
            background: #0f172a;
            padding: 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            color: #cbd5e1;
            white-space: pre-line;
        }
        .indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        .indicator {
            background: #0f172a;
            padding: 12px;
            border-radius: 8px;
        }
        .indicator .label { font-size: 11px; color: #94a3b8; }
        .indicator .value { font-size: 16px; font-weight: 600; margin-top: 4px; }
        @media (max-width: 768px) {
            .detail-panel { width: 100%; }
            th, td { padding: 10px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ðŸ“Š Bandarmology Screener</h1>
            <p>IDX LQ45 Bandar Strength Indicator â€¢ EOD Data</p>
        </div>
    </div>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="label">Total Stocks</div>
                <div class="value" id="total-stocks">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Buy Signals</div>
                <div class="value buy" id="buy-count">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Hold Signals</div>
                <div class="value hold" id="hold-count">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Sell Signals</div>
                <div class="value sell" id="sell-count">-</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="loadData()" id="refresh-btn">ðŸ”„ Refresh Data</button>

        <div id="loading" class="loading" style="display: none;">
            <div>Loading screener data...</div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortBy('symbol')">Stock â†•</th>
                        <th onclick="sortBy('price')">Price â†•</th>
                        <th onclick="sortBy('changePct')">Change â†•</th>
                        <th onclick="sortBy('score')">Score â†•</th>
                        <th onclick="sortBy('signal')">Signal â†•</th>
                    </tr>
                </thead>
                <tbody id="screener-body">
                </tbody>
            </table>
        </div>
    </div>

    <div class="detail-panel" id="detail-panel">
        <button class="close" onclick="closeDetail()">Ã—</button>
        <div id="detail-content"></div>
    </div>

    <script>
        const API_URL = 'http://68.183.229.3:5000/api';
        let screenerData = [];
        let sortField = 'score';
        let sortDesc = true;

        async function loadData() {
            const btn = document.getElementById('refresh-btn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const tbody = document.getElementById('screener-body');
            
            btn.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            tbody.innerHTML = '';

            try {
                const response = await fetch(`${API_URL}/screener`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    screenerData = result.data;
                    updateStats();
                    renderTable();
                } else {
                    throw new Error(result.message);
                }
            } catch (err) {
                error.textContent = 'Error: ' + err.message;
                error.style.display = 'block';
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function updateStats() {
            document.getElementById('total-stocks').textContent = screenerData.length;
            document.getElementById('buy-count').textContent = screenerData.filter(s => s.signal === 'BUY').length;
            document.getElementById('hold-count').textContent = screenerData.filter(s => s.signal === 'HOLD').length;
            document.getElementById('sell-count').textContent = screenerData.filter(s => s.signal === 'SELL').length;
        }

        function sortBy(field) {
            if (sortField === field) {
                sortDesc = !sortDesc;
            } else {
                sortField = field;
                sortDesc = true;
            }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('screener-body');
            
            const sorted = [...screenerData].sort((a, b) => {
                let valA = a[sortField];
                let valB = b[sortField];
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return sortDesc ? 1 : -1;
                if (valA > valB) return sortDesc ? -1 : 1;
                return 0;
            });

            tbody.innerHTML = sorted.map(stock => `
                <tr onclick="showDetail('${stock.symbol}')" style="cursor: pointer;">
                    <td>
                        <div class="stock-name">
                            ${stock.logo ? `<img src="${stock.logo}" alt="${stock.symbol}">` : ''}
                            <div>
                                <div class="symbol">${stock.symbol}</div>
                                <div class="full-name">${stock.name}</div>
                            </div>
                        </div>
                    </td>
                    <td class="price">Rp ${stock.price?.toLocaleString()}</td>
                    <td class="change ${stock.changePct >= 0 ? 'positive' : 'negative'}">
                        ${stock.changePct >= 0 ? '+' : ''}${stock.changePct?.toFixed(2)}%
                    </td>
                    <td class="score" style="color: ${getScoreColor(stock.score)}">${stock.score}</td>
                    <td><span class="signal signal-${stock.signal.toLowerCase()}">${stock.signal}</span></td>
                </tr>
            `).join('');
        }

        function getScoreColor(score) {
            if (score >= 70) return '#22c55e';
            if (score >= 40) return '#eab308';
            return '#ef4444';
        }

        function showDetail(symbol) {
            const stock = screenerData.find(s => s.symbol === symbol);
            if (!stock) return;

            const panel = document.getElementById('detail-panel');
            const content = document.getElementById('detail-content');

            content.innerHTML = `
                <h2>${stock.logo ? `<img src="${stock.logo}" style="width: 40px; height: 40px; border-radius: 8px; vertical-align: middle; margin-right: 12px;">` : ''}${stock.symbol}</h2>
                <p style="color: #94a3b8; margin-bottom: 20px;">${stock.name}</p>
                
                <div style="text-align: center; padding: 20px; background: #0f172a; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 32px; font-weight: bold;">Rp ${stock.price?.toLocaleString()}</div>
                    <div style="color: ${stock.changePct >= 0 ? '#22c55e' : '#ef4444'}; margin-top: 8px;">
                        ${stock.changePct >= 0 ? '+' : ''}${stock.changePct?.toFixed(2)}%
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 48px; font-weight: bold; color: ${getScoreColor(stock.score)};">${stock.score}</div>
                    <span class="signal signal-${stock.signal.toLowerCase()}" style="font-size: 16px; padding: 8px 20px;">${stock.signal}</span>
                </div>

                <div class="indicators">
                    <div class="indicator">
                        <div class="label">Foreign Net</div>
                        <div class="value" style="color: ${stock.indicators?.foreignNet > 0 ? '#22c55e' : '#ef4444'}">
                            ${(stock.indicators?.foreignNetValue / 1000000000).toFixed(2)}B
                        </div>
                    </div>
                    <div class="indicator">
                        <div class="label">Large Lots</div>
                        <div class="value">${stock.indicators?.largeLotCount} blocks</div>
                    </div>
                    <div class="indicator">
                        <div class="label">SID Change</div>
                        <div class="value" style="color: ${stock.indicators?.sidChange > 0 ? '#22c55e' : '#ef4444'}">
                            ${stock.indicators?.sidChange > 0 ? '+' : ''}${stock.indicators?.sidChange}
                        </div>
                    </div>
                    <div class="indicator">
                        <div class="label">Active Brokers</div>
                        <div class="value">${stock.indicators?.brokerActivity}</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 12px;">Analysis</h3>
                <div class="reasoning">${stock.reasoning}</div>
            `;

            panel.classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('active');
        }

        // Load on page load
        loadData();
    </script>
</body>
</html>
